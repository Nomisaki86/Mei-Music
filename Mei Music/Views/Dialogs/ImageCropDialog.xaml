<Window x:Class="Mei_Music.ImageCropDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        mc:Ignorable="d"
        Title="Edit Image"
        Width="520" Height="640"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        WindowStyle="None"
        Background="White">

    <Border CornerRadius="12" Background="White">
        <Border.Effect>
            <DropShadowEffect BlurRadius="20" ShadowDepth="4" Opacity="0.2" Color="Black" Direction="270"/>
        </Border.Effect>
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="52"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="64"/>
            </Grid.RowDefinitions>

            <!-- Title bar -->
            <Grid Grid.Row="0">
                <TextBlock Text="Edit Image" FontSize="16" FontWeight="SemiBold"
                           Foreground="#222222" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                <Button x:Name="TitleCloseButton" Content="âœ•" HorizontalAlignment="Right"
                        VerticalAlignment="Center" Margin="0,0,16,0"
                        Background="Transparent" BorderThickness="0" Cursor="Hand"
                        FontSize="14" Foreground="#888888"
                        Click="CancelButton_Click"/>
            </Grid>

            <!-- Viewport: image is panned/zoomed here; the crop square is always the same size as the viewport -->
            <Border Grid.Row="1" Width="400" Height="400" HorizontalAlignment="Center" CornerRadius="12"
                    ClipToBounds="True" Background="#F0F2F5"
                    x:Name="ViewportBorder">
                <!-- Canvas holds the full image; transforms are applied here -->
                <Canvas x:Name="ImageCanvas"
                        HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                        Background="Transparent"
                        MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                        MouseMove="Canvas_MouseMove"
                        MouseLeftButtonUp="Canvas_MouseLeftButtonUp"
                        MouseWheel="Canvas_MouseWheel"
                        Cursor="SizeAll">
                    <Image x:Name="PreviewImage" Stretch="None"
                           RenderOptions.BitmapScalingMode="HighQuality"
                           RenderTransformOrigin="0,0">
                        <Image.RenderTransform>
                            <TransformGroup>
                                <!-- Index 0: Scale -->
                                <ScaleTransform x:Name="ImgScale" ScaleX="1" ScaleY="1"/>
                                <!-- Index 1: Translate (pan) -->
                                <TranslateTransform x:Name="ImgTranslate" X="0" Y="0"/>
                            </TransformGroup>
                        </Image.RenderTransform>
                    </Image>
                </Canvas>
            </Border>

            <!-- Zoom slider -->
            <Slider x:Name="ZoomSlider" Grid.Row="2"
                    Margin="24,16,24,0"
                    Minimum="0.1" Maximum="3.0" Value="1.0"
                    TickFrequency="0.1"
                    ValueChanged="ZoomSlider_ValueChanged"/>

            <!-- Hint text -->
            <TextBlock Grid.Row="3" Text="* Drag the image to reposition it."
                       FontSize="12" Foreground="#AAAAAA"
                       HorizontalAlignment="Center" Margin="0,6,0,0"/>

            <!-- Action Buttons -->
            <Grid Grid.Row="4" Margin="24,0,24,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="12"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Button x:Name="CancelButton" Grid.Column="0"
                        Content="Cancel" FontSize="14" Height="40"
                        BorderBrush="#DDDDDD" BorderThickness="1"
                        Background="White" Cursor="Hand" VerticalAlignment="Center"
                        Click="CancelButton_Click">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="20" Padding="0,0,0,0">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="#F5F5F5"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Button.Template>
                </Button>

                <Button x:Name="SaveButton" Grid.Column="2"
                        Content="Save" FontSize="14" FontWeight="SemiBold" Height="40"
                        Foreground="White" Background="#FF565C69"
                        BorderThickness="0" Cursor="Hand" VerticalAlignment="Center"
                        Click="SaveButton_Click">
                    <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border x:Name="Bd" Background="{TemplateBinding Background}"
                                    CornerRadius="20" Padding="0,0,0,0">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter TargetName="Bd" Property="Background" Value="#FF474658"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Button.Template>
                </Button>
            </Grid>
        </Grid>
    </Border>
</Window>
